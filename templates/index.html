<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta tags for proper rendering -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Risk Analysis - Insider Threat Detection</title>

    <!-- External CSS libraries -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation bar (same as home page) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('home') }}">
                <i class="fas fa-shield-alt me-2"></i>
                Insider Threat Detection
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('home') }}">Home</a>
                <a class="nav-link active" href="{{ url_for('predict_page') }}">Analyze Employee</a>
                <a class="nav-link" href="{{ url_for('about') }}">About</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page header -->
        <div class="row">
            <div class="col-12">
                <h2 class="text-center mb-4">
                    <i class="fas fa-user-check me-2"></i>
                    Employee Risk Analysis
                </h2>
            </div>
        </div>

        <!-- Flash messages for user feedback -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Check if model is ready before showing form -->
        {% if not model_ready %}
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Model Not Ready:</strong> The machine learning model is not properly loaded.
                Please check that all model files are present in the models/ directory.
            </div>
        {% else %}

            <!-- Main content area with form and results -->
            <div class="row">
                <!-- Input form column -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">
                                <i class="fas fa-keyboard me-2"></i>
                                Enter Employee Data
                            </h4>
                        </div>
                        <div class="card-body">
                            <!-- Form for inputting employee features -->
                            <form method="POST" id="predictionForm">

                                <!-- Activity Pattern Features Section -->
                                <div class="feature-section mb-4">
                                    <h5 class="text-primary mb-3">
                                        <i class="fas fa-chart-line me-2"></i>Activity Patterns
                                    </h5>

                                    <!-- Loop through activity-related features -->
                                    {% for feature in feature_names %}
                                        {% if feature in ['logon_cnt', 'http_cnt', 'email_cnt', 'logon_after_hours_pct', 'logon_weekend_cnt', 'logon_hour_entropy', 'logon_dow_entropy'] %}
                                            <div class="mb-3">
                                                <label for="{{ feature }}" class="form-label">
                                                    {{ feature.replace('_', ' ').title() }}
                                                    <i class="fas fa-info-circle text-muted"
                                                       data-bs-toggle="tooltip"
                                                       title="Feature: {{ feature }}"></i>
                                                </label>
                                                <input type="number"
                                                       class="form-control"
                                                       id="{{ feature }}"
                                                       name="{{ feature }}"
                                                       step="0.01"
                                                       value="{{ result.input_data[feature] if result and feature in result.input_data else '0' }}"
                                                       placeholder="Enter value for {{ feature }}">
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>

                                <!-- USB Activity Features Section -->
                                <div class="feature-section mb-4">
                                    <h5 class="text-success mb-3">
                                        <i class="fas fa-usb me-2"></i>USB Activity
                                    </h5>

                                    {% for feature in feature_names %}
                                        {% if feature in ['usb_cnt', 'usb_act_Connect', 'usb_act_Disconnect', 'usb_after_hours_pct', 'usb_weekend_cnt'] %}
                                            <div class="mb-3">
                                                <label for="{{ feature }}" class="form-label">
                                                    {{ feature.replace('_', ' ').title() }}
                                                    <i class="fas fa-info-circle text-muted"
                                                       data-bs-toggle="tooltip"
                                                       title="Feature: {{ feature }}"></i>
                                                </label>
                                                <input type="number"
                                                       class="form-control"
                                                       id="{{ feature }}"
                                                       name="{{ feature }}"
                                                       step="0.01"
                                                       value="{{ result.input_data[feature] if result and feature in result.input_data else '0' }}"
                                                       placeholder="Enter value for {{ feature }}">
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>

                                <!-- Behavioral Ratios Section -->
                                <div class="feature-section mb-4">
                                    <h5 class="text-info mb-3">
                                        <i class="fas fa-calculator me-2"></i>Behavioral Ratios
                                    </h5>

                                    {% for feature in feature_names %}
                                        {% if feature in ['email_to_http_ratio', 'usb_to_logon_ratio'] %}
                                            <div class="mb-3">
                                                <label for="{{ feature }}" class="form-label">
                                                    {{ feature.replace('_', ' ').title() }}
                                                    <i class="fas fa-info-circle text-muted"
                                                       data-bs-toggle="tooltip"
                                                       title="Feature: {{ feature }}"></i>
                                                </label>
                                                <input type="number"
                                                       class="form-control"
                                                       id="{{ feature }}"
                                                       name="{{ feature }}"
                                                       step="0.001"
                                                       value="{{ result.input_data[feature] if result and feature in result.input_data else '0' }}"
                                                       placeholder="Enter value for {{ feature }}">
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>

                                <!-- Personality Traits Section -->
                                <div class="feature-section mb-4">
                                    <h5 class="text-warning mb-3">
                                        <i class="fas fa-user me-2"></i>Personality Traits (Big Five)
                                    </h5>

                                    {% for feature in feature_names %}
                                        {% if feature in ['O', 'C', 'E', 'A', 'N'] %}
                                            <div class="mb-3">
                                                <label for="{{ feature }}" class="form-label">
                                                    {% if feature == 'O' %}Openness (O)
                                                    {% elif feature == 'C' %}Conscientiousness (C)
                                                    {% elif feature == 'E' %}Extraversion (E)
                                                    {% elif feature == 'A' %}Agreeableness (A)
                                                    {% elif feature == 'N' %}Neuroticism (N)
                                                    {% endif %}
                                                    <i class="fas fa-info-circle text-muted"
                                                       data-bs-toggle="tooltip"
                                                       title="Personality trait: {{ feature }} (typically 1-5 scale)"></i>
                                                </label>
                                                <input type="number"
                                                       class="form-control"
                                                       id="{{ feature }}"
                                                       name="{{ feature }}"
                                                       step="0.1"
                                                       min="0"
                                                       max="5"
                                                       value="{{ result.input_data[feature] if result and feature in result.input_data else '0' }}"
                                                       placeholder="Enter score 0-5">
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>

                                <!-- Psychological Risk Section -->
                                <div class="feature-section mb-4">
                                    <h5 class="text-danger mb-3">
                                        <i class="fas fa-brain me-2"></i>Psychological Risk
                                    </h5>

                                    {% for feature in feature_names %}
                                        {% if feature == 'psych_risk' %}
                                            <div class="mb-3">
                                                <label for="{{ feature }}" class="form-label">
                                                    Psychological Risk Score
                                                    <i class="fas fa-info-circle text-muted"
                                                       data-bs-toggle="tooltip"
                                                       title="Psychological risk assessment score (higher = more risk)"></i>
                                                </label>
                                                <input type="number"
                                                       class="form-control"
                                                       id="{{ feature }}"
                                                       name="{{ feature }}"
                                                       step="0.01"
                                                       value="{{ result.input_data[feature] if result and feature in result.input_data else '0' }}"
                                                       placeholder="Enter psychological risk score">
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>

                                <!-- Submit button -->
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-search me-2"></i>
                                        Analyze Risk
                                    </button>
                                </div>

                                <!-- Quick fill buttons for testing -->
                                <div class="mt-3">
                                    <small class="text-muted">Quick Fill Options:</small>
                                    <div class="btn-group w-100 mt-2" role="group">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="fillSampleData('normal')">
                                            Normal Employee
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="fillSampleData('suspicious')">
                                            Suspicious Employee
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearForm()">
                                            Clear All
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Results display column -->
                <div class="col-lg-6">
                    {% if result %}
                        <!-- Show results if prediction was made -->
                        <div class="card">
                            <div class="card-header bg-{{ result.threat_class }} text-white">
                                <h4 class="mb-0">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Risk Assessment Results
                                </h4>
                            </div>
                            <div class="card-body">
                                <!-- Threat status display -->
                                <div class="text-center mb-4">
                                    <h2 class="text-{{ result.threat_class }} mb-3">
                                        {% if result.prediction == 1 %}
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                        {% else %}
                                            <i class="fas fa-check-circle me-2"></i>
                                        {% endif %}
                                        {{ result.threat_status }}
                                    </h2>

                                    <!-- Confidence percentage with progress bar -->
                                    <div class="mb-3">
                                        <h5>Confidence: {{ result.confidence_percentage }}%</h5>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-{{ result.threat_class }}"
                                                 role="progressbar"
                                                 style="width: {{ result.confidence_percentage }}%">
                                                {{ result.confidence_percentage }}%
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Detailed message about the assessment -->
                                <div class="alert alert-{{ result.threat_class }}" role="alert">
                                    <p class="mb-0">{{ result.message }}</p>
                                </div>

                                <!-- Additional details about the prediction -->
                                <div class="mt-4">
                                    <h6>Assessment Details:</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Prediction Value:</strong> {{ result.prediction }}</li>
                                        <li><strong>Risk Probability:</strong> {{ "%.4f"|format(result.probability) }}</li>
                                        <li><strong>Classification:</strong>
                                            {{ "Insider Threat Detected" if result.prediction == 1 else "Normal Behavior" }}
                                        </li>
                                        <li><strong>Analysis Date:</strong> {{ moment().format('YYYY-MM-DD HH:mm:ss') if moment else 'Current' }}</li>
                                    </ul>
                                </div>

                                <!-- Key risk indicators -->
                                <div class="mt-4">
                                    <h6>Key Risk Indicators:</h6>
                                    <div class="risk-indicators">
                                        {% if result.input_data %}
                                            {% if result.input_data.get('logon_after_hours_pct', 0) > 20 %}
                                                <span class="badge bg-warning me-1">High After-Hours Activity</span>
                                            {% endif %}
                                            {% if result.input_data.get('usb_after_hours_pct', 0) > 30 %}
                                                <span class="badge bg-warning me-1">Unusual USB Usage</span>
                                            {% endif %}
                                            {% if result.input_data.get('psych_risk', 0) > 0.5 %}
                                                <span class="badge bg-danger me-1">Elevated Psychological Risk</span>
                                            {% endif %}
                                            {% if result.input_data.get('email_to_http_ratio', 0) > 0.1 %}
                                                <span class="badge bg-info me-1">High Email Activity</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Recommendations based on risk level -->
                                <div class="mt-4">
                                    <h6>Recommendations:</h6>
                                    {% if result.prediction == 1 %}
                                        <div class="alert alert-warning">
                                            <ul class="mb-0">
                                                <li><strong>Immediate:</strong> Increase monitoring of this employee</li>
                                                <li><strong>Security:</strong> Review and potentially restrict access permissions</li>
                                                <li><strong>Investigation:</strong> Conduct thorough security assessment</li>
                                                <li><strong>Training:</strong> Provide additional security awareness training</li>
                                                <li><strong>Documentation:</strong> Record findings for security team review</li>
                                            </ul>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-success">
                                            <ul class="mb-0">
                                                <li><strong>Status:</strong> Employee shows normal behavior patterns</li>
                                                <li><strong>Monitoring:</strong> Continue standard monitoring procedures</li>
                                                <li><strong>Action:</strong> No immediate action required</li>
                                                <li><strong>Schedule:</strong> Regular reassessment recommended (monthly/quarterly)</li>
                                                <li><strong>Maintenance:</strong> Keep employee data updated for accuracy</li>
                                            </ul>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Action buttons -->
                                <div class="text-center mt-4">
                                    <button type="button" class="btn btn-secondary me-2" onclick="resetForm()">
                                        <i class="fas fa-redo me-2"></i>
                                        Analyze Another Employee
                                    </button>
                                    <button type="button" class="btn btn-info" onclick="exportResults()">
                                        <i class="fas fa-download me-2"></i>
                                        Export Results
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <!-- Show instructions when no results yet -->
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h4 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Instructions
                                </h4>
                            </div>
                            <div class="card-body">
                                <h5>How to Use This System:</h5>
                                <ol>
                                    <li><strong>Fill in Employee Data:</strong> Enter values for each behavioral feature in the form on the left.</li>
                                    <li><strong>Activity Patterns:</strong> Include login counts, timing patterns, and system usage data.</li>
                                    <li><strong>USB Activity:</strong> Enter USB device usage patterns and timing information.</li>
                                    <li><strong>Behavioral Ratios:</strong> Include calculated ratios like email-to-HTTP and USB-to-login.</li>
                                    <li><strong>Personality Traits:</strong> Enter Big Five personality scores (typically 1-5 scale).</li>
                                    <li><strong>Psychological Risk:</strong> Include psychological risk assessment score.</li>
                                    <li><strong>Analyze:</strong> Click the "Analyze Risk" button to get the threat assessment.</li>
                                </ol>

                                <div class="alert alert-info mt-3">
                                    <h6><i class="fas fa-lightbulb me-2"></i>Tips for Accurate Analysis:</h6>
                                    <ul class="mb-0">
                                        <li><strong>Precision:</strong> Use decimal values for precise measurements</li>
                                        <li><strong>Percentages:</strong> Enter values between 0 and 100 for percentage fields</li>
                                        <li><strong>Personality:</strong> Big Five traits are typically scored 1-5</li>
                                        <li><strong>Missing Data:</strong> Leave fields as 0 if data is not available</li>
                                        <li><strong>Sample Data:</strong> Use "Quick Fill" buttons to test with sample data</li>
                                    </ul>
                                </div>

                                <div class="alert alert-warning mt-3">
                                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Notes:</h6>
                                    <ul class="mb-0">
                                        <li>This system is for risk assessment only, not final decisions</li>
                                        <li>Results should be reviewed by security professionals</li>
                                        <li>Regular model updates and retraining are recommended</li>
                                        <li>Consider multiple factors beyond this analysis</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>

    <!-- JavaScript section -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>

    <script>
        // Initialize Bootstrap tooltips for feature descriptions
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Function to reset the form for analyzing another employee
        function resetForm() {
            // Reset all form fields to 0
            document.getElementById('predictionForm').reset();

            // Set all numeric inputs back to 0
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.value = '0';
            });

            // Scroll back to top of form
            document.getElementById('predictionForm').scrollIntoView({
                behavior: 'smooth'
            });

            // Reload page to clear results
            setTimeout(() => {
                window.location.href = "{{ url_for('predict_page') }}";
            }, 500);
        }

        // Function to fill form with sample data for testing
        function fillSampleData(type) {
            if (type === 'normal') {
                // Normal employee sample data
                document.getElementById('logon_cnt').value = '45';
                document.getElementById('http_cnt').value = '234';
                document.getElementById('email_cnt').value = '12';
                document.getElementById('usb_cnt').value = '2';
                document.getElementById('logon_after_hours_pct').value = '5.5';
                document.getElementById('logon_weekend_cnt').value = '1';
                document.getElementById('logon_hour_entropy').value = '1.8';
                document.getElementById('logon_dow_entropy').value = '1.2';
                document.getElementById('usb_act_Connect').value = '2';
                document.getElementById('usb_act_Disconnect').value = '2';
                document.getElementById('usb_after_hours_pct').value = '10.0';
                document.getElementById('usb_weekend_cnt').value = '0';
                document.getElementById('email_to_http_ratio').value = '0.051';
                document.getElementById('usb_to_logon_ratio').value = '0.044';
                document.getElementById('O').value = '3.2';
                document.getElementById('C').value = '4.1';
                document.getElementById('E').value = '3.8';
                document.getElementById('A').value = '3.7';
                document.getElementById('N').value = '2.4';
                document.getElementById('psych_risk').value = '0.2';
            } else if (type === 'suspicious') {
                // Suspicious employee sample data
                document.getElementById('logon_cnt').value = '78';
                document.getElementById('http_cnt').value = '456';
                document.getElementById('email_cnt').value = '8';
                document.getElementById('usb_cnt').value = '12';
                document.getElementById('logon_after_hours_pct').value = '45.5';
                document.getElementById('logon_weekend_cnt').value = '8';
                document.getElementById('logon_hour_entropy').value = '2.8';
                document.getElementById('logon_dow_entropy').value = '2.1';
                document.getElementById('usb_act_Connect').value = '12';
                document.getElementById('usb_act_Disconnect').value = '12';
                document.getElementById('usb_after_hours_pct').value = '60.0';
                document.getElementById('usb_weekend_cnt').value = '5';
                document.getElementById('email_to_http_ratio').value = '0.018';
                document.getElementById('usb_to_logon_ratio').value = '0.154';
                document.getElementById('O').value = '2.1';
                document.getElementById('C').value = '2.8';
                document.getElementById('E').value = '1.9';
                document.getElementById('A').value = '2.2';
                document.getElementById('N').value = '4.1';
                document.getElementById('psych_risk').value = '0.8';
            }
        }

        // Function to clear all form fields
        function clearForm() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.value = '0';
            });
        }

        // Form validation before submission
        document.getElementById('predictionForm').addEventListener('submit', function(e) {
            const inputs = document.querySelectorAll('input[type="number"]');
            let hasValue = false;

            // Check if at least one field has a non-zero value
            inputs.forEach(input => {
                if (parseFloat(input.value) !== 0) {
                    hasValue = true;
                }
            });

            // Warn user if all fields are zero
            if (!hasValue) {
                const proceed = confirm('All fields are set to 0. This may not provide meaningful results. Do you want to proceed?');
                if (!proceed) {
                    e.preventDefault();
                }
            }
        });

        // Add loading state to form submission
        document.getElementById('predictionForm').addEventListener('submit', function() {
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
            submitBtn.disabled = true;

            // Reset button after 10 seconds (in case of errors)
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }, 10000);
        });

        // Function to export results (basic implementation)
        function exportResults() {
            {% if result %}
                const resultData = {
                    timestamp: new Date().toISOString(),
                    threat_status: "{{ result.threat_status }}",
                    prediction: {{ result.prediction }},
                    confidence: {{ result.confidence_percentage }},
                    input_data: {{ result.input_data | tojson }},
                    message: "{{ result.message }}"
                };

                const dataStr = JSON.stringify(resultData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = 'threat_analysis_results.json';
                link.click();

                URL.revokeObjectURL(url);
            {% endif %}
        }
    </script>
</body>
</html>